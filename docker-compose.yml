services:
  mysql:
    image: mysql:${MYSQL_VER}
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        # run initialization
        run-script.sh +patch-db
        # run entrypoint
        docker-entrypoint.sh mysqld
    volumes:
      - ./var/mysql:/var/lib/mysql
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - ./scripts/patch-db.sh:/scripts/patch-db.sh
      - ./data/sql:/sql
      - ./data/patches:/sql-patches
    environment:
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
  mongodb:
    image: mongo:${MONGODB_VER}
    restart: unless-stopped
    volumes:
      - ./var/mongodb:/data/db
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD}
  node:
    image: node:${NODE_VER}-bookworm
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        export TARGET_DIR=/home/nodeapp
        export EXCLUDE_FILE=/config/node-exclude.txt
        # run initialization
        run-script.sh timezone sync-src hostkey
        # setup configuration
        cp /config/app.json $${TARGET_DIR}
        cd "$${TARGET_DIR}"
        if [ ! -d node_modules ]; then
          npm install
        fi
        # run entrypoint
        CERT_DIR=/config/cert
        docker-entrypoint.sh node app.js \
          --ssl-key=$${CERT_DIR}/cert.key \
          --ssl-cert=$${CERT_DIR}/cert.crt-combined \
          --config=app.json
    expose:
      - 443
    working_dir: /home/nodeapp
    environment:
      APP_TIMEZONE: ${APP_TIMEZONE}
      APT_MIRROR: ${APT_MIRROR}
    volumes:
      - ./config:/config
      - ./scripts:/scripts
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./src/nodeapp:/src
    extra_hosts:
      - host.docker.internal:host-gateway
  php:
    image: php:${PHP_VER}-apache
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        export TARGET_DIR=/home/www
        export EXCLUDE_FILE=/config/www-exclude.txt
        # run initialization
        run-script.sh timezone sync-src apt php-init:init +sshd
        # set apache site configuration
        rm -rf $${APACHE_CONFDIR}/sites-enabled/*
        ln -s /config/app.conf $${APACHE_CONFDIR}/sites-enabled/
        # enable ssl and rewrite module
        a2enmod ssl rewrite
        # run entrypoint
        docker-php-entrypoint apache2-foreground
    expose:
      - 443
    healthcheck:
      test: cat /tmp/.ready
      start_period: 30s
      start_interval: 15s
    working_dir: /home/www
    environment:
      APP_DEBUG: ${APP_DEBUG}
      APP_TIMEZONE: ${APP_TIMEZONE}
      APT_MIRROR: ${APT_MIRROR}
    volumes:
      - ./config:/config
      - ./scripts:/scripts
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./src/www:/src
      - ./var/cache:/cache
    depends_on:
      - mysql
      - mongodb
    deploy:
      mode: replicated
      replicas: 1
      endpoint_mode: vip
  nginx:
    image: nginx:${NGINX_VER}
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        # run initialization
        run-script.sh timezone
        # run entrypoint
        /docker-entrypoint.sh nginx -g "daemon off;"
    environment:
      APP_TIMEZONE: ${APP_TIMEZONE}
      APT_MIRROR: ${APT_MIRROR}
    ports:
      - ${APP_HTTP_PORT}:80
      - ${APP_HTTPS_PORT}:443
    volumes:
      - ./config:/config
      - ./config/default.conf.template:/etc/nginx/templates/default.conf.template
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
    depends_on:
      - php
  cron:
    image: debian:bookworm-slim
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        export CRON_DIR=/cron
        # run initialization
        run-script.sh timezone hostkey apt cron ssh
        # start cron
        echo "Starting cron..."
        cron -f -L 15
    environment:
      APP_TIMEZONE: ${APP_TIMEZONE}
      APT_MIRROR: ${APT_MIRROR}
    volumes:
      - ./config:/config
      - ./scripts:/scripts
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./cron:/cron
